<!DOCTYPE html>
<html>
  <head>
    <title>Cory&#39;s Simple HL7 App</title>
    <script src="../example-smart-app/lib/js/fhir-client-v0.1.12.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.min.js"></script>
  </head>
  <body>
    <h1><span id="name"></span></h1>
    <h2>Conditions</h2>
    <table id="condition_table" name="condition_table"><tbody id="condition_list" name="condition_list"></tbody></table>
    <h2>Medications</h2>
    <ol id="med_list"></ol>
    <h2>Encounters</h2>
    <table id="enc_table" name="enc_table"><tbody id="enc_list" name="enc_list"></tbody></table>
    <h2>Observations</h2>
    <table id="obs_table" name="obs_table"><tbody id="obs_list" name="obs_list"></tbody></table>
    
    <script type="text/javascript">
        function getPatientName (pt) {
            if (pt.name) {
                var names = pt.name.map(function(name) {
                    return name.given.join(" ") + " " + name.family.join(" ");
                });
                return names.join(" / ")
            } else {
                return "anonymous";
            }
        }
      
        var med_list = document.getElementById('med_list');
      
        function getMedicationName (medCodings) {
            var coding = medCodings.find(function(c){
                return c.system == "http://www.nlm.nih.gov/research/umls/rxnorm";
            });

            return coding && coding.display || "Unnamed Medication(TM)"
        }
      
        function displayMedication (medCodings) {
            med_list.innerHTML += "<li> " + getMedicationName(medCodings) + "</li>";
        } 
      
        function displayObsName (obsCoding) {
            var obsCode = obsCoding.find(function(x){
              return x.system == "http://loinc.org";
            });
          
            return obsCode.display;
        }
      
        function displayObsResult (obs) {
          var txtObsResult = "Empty";
          var numObsResult = 0;
          if (obs.component) {
            txtObsResult = obs.component[0].valueQuantity.value + "<br>" + obs.component[1].valueQuantity.value;
            txtObsResult += "</td><td>";
            txtObsResult += obs.component[0].valueQuantity.unit + "<br>" + obs.component[1].valueQuantity.unit;
          } else { 
            txtObsResult = obs.valueQuantity.value;
            numObsResult = txtObsResult.toFixed(2);
            txtObsResult = numObsResult.toString() + "</td><td>" + obs.valueQuantity.unit;
          }
          return txtObsResult                                                                        
        }

        function displayObsCategory (obsCategory) {
            var obsCatCode = obsCategory.find(function(z){
              return z.system == "http://hl7.org/fhir/observation-category";
            });
          
            return obsCatCode.code
        }
 
        function displayPatient (pt) {
            document.getElementById('name').innerHTML = getPatientName(pt);
            $("span#name").prepend("Patient Name: ");
        }
      
        function sortTable( strTableId, intColNum ){
                strTableId = "#" + strTableId;
                var strQuery = strTableId + " tbody  tr";
                var rows = $(strQuery).get();
                var strRowCount;
                rows.sort(function(a, b) {
                  var A = $(a).children('td').eq(intColNum).text().toUpperCase();
                  var B = $(b).children('td').eq(intColNum).text().toUpperCase();
                  if(A < B) { return -1; }
                  if(A > B) { return 1;  }
                  return 0;
                });
                $.each(rows, function(index, row) {
                  $(strTableId).children('tbody').append(row);
                });
                // Append row numbers after the table sort
                $(strTableId).find('tr').each(function(){
                    strRowCount = $(this).index() + 1;
                    strRowCount = "<td>" + strRowCount + "</td>";
                    $(this).find('td').eq(0).before(strRowCount);
                });
        }
      
        var obs_text;               

        FHIR.oauth2.ready(function(smart){
            smart.patient.read().then(function(pt) {
                displayPatient (pt);
            });
            smart.patient.api.fetchAllWithReferences({type: "MedicationOrder"},["MedicationOrder.medicationReference"]).then(function(results, refs) {
               results.forEach(function(prescription){
                    if (prescription.medicationCodeableConcept) {
                        displayMedication(prescription.medicationCodeableConcept.coding);
                    } else if (prescription.medicationReference) {
                        var med = refs(prescription, prescription.medicationReference);
                        displayMedication(med && med.code.coding || []);
                    }
               });
            });
            smart.patient.api.fetchAll({type: "Condition"}).then(function(results) {
               results.forEach(function(condition){
                 txtCondition = "<tr><td>" + condition.code.text + "</td>";
                 txtCondition += "<td>" + condition.onsetDateTime.substring(0,10) + "</td>";
                 txtCondition += "<td>" + condition.id + "</td>";
                 txtCondition += "</tr>";
                 document.getElementById('condition_list').innerHTML += txtCondition;
               });
              sortTable("condition_table", 1);
            });
          smart.patient.api.fetchAll({type: "Encounter"}).then(function(results) {
               results.forEach(function(encounter){
                 txtEncounter = "<tr><td>" + encounter.period.start.substring(0,10) + "</td>";
                 txtEncounter += "</tr>";
                 document.getElementById('enc_list').innerHTML += txtEncounter;
               });
              sortTable("enc_table", 0);
            });
            smart.patient.api.fetchAll({type: "Observation"}).then(function(results) {
               results.forEach(function(observation){
                 obs_text = "<tr><td>" + displayObsCategory(observation.category.coding) + "</td>";
                 obs_text += "<td>" + observation.effectiveDateTime.substring(0,10) + "</td>";
                 obs_text += "<td>" + displayObsName(observation.code.coding) + "</td>";
                 obs_text += "<td>" + displayObsResult(observation) + "</td>";
                 obs_text += "<td>" + observation.id + "</td>";
                 obs_text += "</tr>";
                 document.getElementById('obs_list').innerHTML += obs_text;
               });
               sortTable("obs_table", 1);
            });
        });
      
    </script>
  </body>
</html>
