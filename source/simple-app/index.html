<!DOCTYPE html>
<html>
  <head>
    <title>Cory&#39;s Simple HL7 App</title>
    <script src="../example-smart-app/lib/js/fhir-client-v0.1.12.js"></script>
  </head>
  <body>
    <h1><span id="name"></span></h1>
    <h2>Medications</h2>
    <ol id="med_list"></ol>
    <h2>Observations</h2>
    <table id="obs_list"></table>
    
    <script type="text/javascript">
        function getPatientName (pt) {
            if (pt.name) {
                var names = pt.name.map(function(name) {
                    return name.given.join(" ") + " " + name.family.join(" ");
                });
                return names.join(" / ")
            } else {
                return "anonymous";
            }
        }

        function getMedicationName (medCodings) {
            var coding = medCodings.find(function(c){
                return c.system == "http://www.nlm.nih.gov/research/umls/rxnorm";
            });

            return coding && coding.display || "Unnamed Medication(TM)"
        }
      
        function displayObsName (obsCodings) {
            return obsCodings.text
        }

        function displayPatient (pt) {
            document.getElementById('name').innerHTML = getPatientName(pt);
        }

        var med_list = document.getElementById('med_list');
        var i = 1;
        var obs_text;

        function displayMedication (medCodings) {
            med_list.innerHTML += "<li> " + getMedicationName(medCodings) + "</li>";
        }                

        FHIR.oauth2.ready(function(smart){
            smart.patient.read().then(function(pt) {
                displayPatient (pt);
            });
            smart.patient.api.fetchAllWithReferences({type: "MedicationOrder"},["MedicationOrder.medicationReference"]).then(function(results, refs) {
               results.forEach(function(prescription){
                    if (prescription.medicationCodeableConcept) {
                        displayMedication(prescription.medicationCodeableConcept.coding);
                    } else if (prescription.medicationReference) {
                        var med = refs(prescription, prescription.medicationReference);
                        displayMedication(med && med.code.coding || []);
                    }
               });
            });
            smart.patient.api.fetchAll({type: "Observation"}).then(function(results) {
               results.forEach(function(observation){
                 if (i == 1) { obs_text = "<tr><th></th><th>Observation Name</th><th>Value</th></tr>"; }
                 obs_text += "<tr><td>" + i + "</td><td>" + displayObsName(observation.code) + "</td>";
                 obs_text += "<td>" + observation.valueQuantity.value + "</td>";
                 obs_text += "</tr>";
                 document.getElementById('obs_list').innerHTML += obs_text;
                 i++;
               });
            });
        });
    </script>
  </body>
</html>
