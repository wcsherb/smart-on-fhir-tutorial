<!DOCTYPE html>
<html>
  <head>
    <title>Cory&#39;s Simple HL7 App</title>
    <script src="../example-smart-app/lib/js/fhir-client-v0.1.12.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20160511/json2.min.js"></script>
  </head>
  <body>
    <h1><span id="name"></span><span id="dob"></span></h1>
    <h2>Conditions</h2>
    <table id="condition_table" name="condition_table"><tbody id="condition_list" name="condition_list"></tbody></table>
    <h2>Medication Orders</h2>
    <table id="med_table" name="med_table"><tbody id="med_list" name="med_list"></tbody></table>
    <h2>Encounters</h2>
    <table id="enc_table" name="enc_table"><tbody id="enc_list" name="enc_list"></tbody></table>
    <h2>Observations</h2>
    <table id="obs_table" name="obs_table"><tbody id="obs_list" name="obs_list"></tbody></table>
    
    <script type="text/javascript">
        function getPatientName (pt) {
            if (pt.name) {
                var names = pt.name.map(function(name) {
                    return name.given.join(" ") + " " + name.family.join(" ");
                });
                return names.join(" / ");
            } else {
                return "anonymous";
            }
        }
      
        function getPatientDOB (pt) {
                return " " + pt.birthDate;
        }
      
        function displayObsResult (obs) {
          var txtObsResult = "Empty";
          var numObsResult = 0;
          if (obs.component) {
            txtObsResult = obs.component[0].valueQuantity.value + "<br>" + obs.component[1].valueQuantity.value;
            txtObsResult += "</td><td>";
            txtObsResult += obs.component[0].valueQuantity.unit + "<br>" + obs.component[1].valueQuantity.unit;
          } else { 
            txtObsResult = obs.valueQuantity.value;
            numObsResult = txtObsResult.toFixed(2);
            txtObsResult = numObsResult.toString() + "</td><td>" + obs.valueQuantity.unit;
          }
          return txtObsResult                                                                        
        }
 
        function displayPatient (pt) {
            document.getElementById('name').innerHTML = getPatientName(pt);
            document.getElementById('dob').innerHTML = getPatientDOB(pt);
           // $("span#name").prepend("Patient Name: ");
        }
      
        function sortTable( strTableId, intColNum ){
                var strTableName = strTableId;
                strTableId = "#" + strTableId;
                var strQuery = strTableId + " tbody  tr";
                var rows = $(strQuery).get();
                var strRowCount;
                var strDOB;
                var strDate;
                rows.sort(function(a, b) {
                  var A = $(a).children('td').eq(intColNum).text().toUpperCase();
                  var B = $(b).children('td').eq(intColNum).text().toUpperCase();
                  if(A < B) { return -1; }
                  if(A > B) { return 1;  }
                  return 0;
                });
                $.each(rows, function(index, row) {
                  $(strTableId).children('tbody').append(row);
                });
                // Append row numbers after the table sort
                $(strTableId).find('tr').each(function(){
                    strRowCount = $(this).index() + 1;
                    strRowCount = "<td>" + strRowCount + "</td>";
                    $(this).find('td').eq(0).before(strRowCount);
                // Add the age of the patient on each row
                    strDate = $(this).children('td').eq(1).text();
                    strDOB = $("span#dob").text();
                    var dtDOB = new Date(strDOB);
                    var dtDate = new Date(strDate);
                    var intDays = dtDate - dtDOB;
                    // var strYears = "<td>" + intDays + "</td>";
                    $(this).children('td').last().after("Blah");
                });
        }
      
        var obs_text;               

        FHIR.oauth2.ready(function(smart){
            smart.patient.read().then(function(pt) {
                displayPatient (pt);
            });
            smart.patient.api.fetchAll({type: "MedicationOrder"}).then(function(results) {
               results.forEach(function(medOrder){
                 var txtMedOrder = "<tr><td>" + medOrder.dateWritten + "</td>";
                 txtMedOrder += "<td>" + medOrder.medicationCodeableConcept.text + "</td>";
                 // txtMedOrder += "<td>" + medOrder.id + "</td>";
                 txtMedOrder += "</tr>";
                 document.getElementById('med_list').innerHTML += txtMedOrder;
               });
              sortTable("med_table", 0);
            });
            smart.patient.api.fetchAll({type: "Condition"}).then(function(results) {
               results.forEach(function(condition){
                 var txtCondition = "<tr><td>" + condition.onsetDateTime.substring(0,10) + "</td>";
                 txtCondition += "<td>" + condition.code.text + "</td>";
                // txtCondition += "<td>" + condition.id + "</td>";
                 txtCondition += "</tr>";
                 document.getElementById('condition_list').innerHTML += txtCondition;
               });
              sortTable("condition_table", 0);
            });
          smart.patient.api.fetchAll({type: "Encounter"}).then(function(results) {
               results.forEach(function(encounter){
                 var txtEncounter = "<tr><td>" + encounter.period.start.substring(0,10) + "</td>";
                 txtEncounter += "<td>" + encounter.type[0].text + "</td>";
                 txtEncounter += "</tr>";
                 document.getElementById('enc_list').innerHTML += txtEncounter;
               });
              sortTable("enc_table", 0);
            });
            smart.patient.api.fetchAll({type: "Observation"}).then(function(results) {
               results.forEach(function(observation){
                 var obs_text = "<tr><td>" + observation.effectiveDateTime.substring(0,10) + "</td>";
                 obs_text += "<td>" + observation.category.coding[0].code + "</td>";
                 obs_text += "<td>" + observation.code.coding[0].display + "</td>";
                 obs_text += "<td>" + displayObsResult(observation) + "</td>";
               //  obs_text += "<td>" + observation.id + "</td>";
                 obs_text += "</tr>";
                 document.getElementById('obs_list').innerHTML += obs_text;
               });
               sortTable("obs_table", 0);
            });
        });
      
    </script>
  </body>
</html>
